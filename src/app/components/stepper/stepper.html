<mat-stepper class="stepper" [linear]="isLinear" #stepper>
    <mat-step label="Select Customer">
        <app-service-entities-form [customers]="customers" [orgEntities]="orgEntities" [applications]="applications"
            [oidcProviders]="oidcProviders" (customerChanged)="selectCustomer($event)" (oesChanged)="selectOe($event)"
            (applicationChanged)="selectapplication($event)"
            (instrospecionEndpointChanged)="selectIntrospection($event)"
            (storageRegionChanged)="selectStorageRegion($event)" 
            (oidcProvidersChanged)="selectOidcProvider($event)">
        </app-service-entities-form>
    </mat-step>
    <mat-step label="Role Configuration" style="display: flex;">
        <div style="display: flex; flex-direction: column; width: 500px; margin-left: auto; margin-right: auto;">
            <form [formGroup]="roleConfigFormGroup" style="display: flex; flex-direction: column;">
                @for (flow of selectedApplication?.applicationFlows; track flow) {
                <div class="field-label">
                    <mat-label>Select role for flow {{flow.flowCode}}</mat-label>
                    <mat-form-field style="width: 400px;">
                        <mat-label>Roles config {{flow.flowCode}}</mat-label>
                        <mat-select formControlName="roles" (selectionChange)="addRole(flow.id)">
                            @for (role of roles; track role) {
                            <mat-option [value]="role.name">{{role.name}}</mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                </div>
                }
            </form>
        </div>
    </mat-step>

    <mat-step label="Configure flows" style="display: flex;">
        @for (flow of selectedApplication.applicationFlows; track flow) {

        <div style="display: flex; justify-content: center; align-items: center;">
            <mat-card class="application-card" appearance="filled">
                <mat-card-header style="display: flex; align-items: center;justify-content: center;padding: 5px;">
                    <mat-card-subtitle>{{flow.flowCode}} Flow Configuration</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content style=" display:flex;flex-direction: column;">
                    <div>
                        <form [formGroup]="fileTypesForm" style="display:flex; gap: 10px;">
                            <mat-form-field style=" height: 70px; width: 250px;">
                                <mat-label>Action</mat-label>
                                <mat-select formControlName="action" required>
                                    @for (food of action; track food) {
                                    <mat-option [value]="food.name">{{food.name}}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field style="height: 70px">
                                <mat-label>Type</mat-label>
                                <mat-select formControlName="type" required>
                                    @for (file of fileTypes; track file) {
                                    <mat-option [value]="file">{{file}}</mat-option>
                                    }
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field style=" height: 70px">
                                <mat-label>File size</mat-label>
                                <input matInput placeholder="Application description" formControlName="size" required>
                            </mat-form-field>
                        </form>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button [disabled]="!selectedConfiguration" (click)="copyConfiguration(flow.id)"
                                matButton="outlined" style="display: flex;; border-radius: 5px; height: 25px;">
                                <mat-icon>content_copy</mat-icon>
                                Clone
                            </button>
                            <button [disabled]="addButonDisabled" (click)="addConfiguration(flow)" matButton="filled"
                                style="display: flex; border-radius: 5px; height: 25px;">
                                <mat-icon>playlist_add</mat-icon>
                                Add
                            </button>
                        </div>
                        <div
                            style="margin-top: 10px; height: 200px; overflow-y: auto; display: flex; flex-direction: column;">
                            @for (config of configurations; track config) {
                            @if (config.flowId === flow.id) {
                            <mat-chip-listbox class="mat-mdc-chip-set-stacked" aria-label="Cutest dog breeds">
                                <mat-chip-option color="primary" [selected]="consfigurationSelected(config.flowId)"
                                    (click)="selectConfiguration(config)">
                                    Type: {{config.type}} | Action: {{config.action}} | Size: {{config.size}}MB
                                    <button matChipRemove (click)="deleteConfiguration(configurations.indexOf(config))">
                                        <mat-icon>cancel</mat-icon>
                                    </button>
                                </mat-chip-option>
                            </mat-chip-listbox>
                            }}
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

        </div>
        <hr>
        }
    </mat-step>

    <mat-step label="Onboard Application">
        <mat-card class="application-card"
            style=" margin-left: auto; margin-right: auto; height: auto; box-shadow: none;">
            <mat-card-header style="display: flex; align-items: center; justify-content: center;">
                <mat-card-subtitle>Application Summary</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content style="padding: 20px;">
                <div
                    style="display: flex; flex-direction: column; gap: 10px;width: 300px; margin-left: auto; margin-right: auto;">
                    <div style="display: flex; flex-direction: column;  justify-content: start;">
                        <span><strong>Customer:</strong></span>
                        <span>{{serviceEntities.customer.name}}</span>
                    </div>
                    <div style="display: flex; flex-direction: column;  justify-content: start;">
                        <span><strong>OrgEntity:</strong></span>
                        <span>{{serviceEntities.orgEntity.name}}</span>
                    </div>
                    <div style="display: flex; flex-direction: column;  justify-content: start;">
                        <span><strong>Application:</strong></span>
                        <span>{{serviceEntities.application.name}}</span>
                    </div>
                    <div style="display: flex; flex-direction: column;  justify-content: start; ">
                        <span><strong>OIDC Provider:</strong></span>
                        <span>{{serviceEntities.oidcProviders}}</span>
                    </div>
                    <div style="display: flex ; flex-direction: column; justify-content: flex-start;">
                        <span><strong>Introspection Endpoint:</strong></span>
                        <span>{{serviceEntities.instrospecionEndpoint}}</span>
                    </div>
                    <div style="display: flex; flex-direction: column;  justify-content: flex-start">
                        <span><strong>Storage Region:</strong></span>
                        <span>{{serviceEntities.storageRegion}}</span>
                    </div>
                    <div style="display: flex; flex-direction: column;  justify-content: flex-start;">
                        <span><strong>Status:</strong></span>
                        <span>{{serviceEntities.status}}</span>
                    </div>
                </div>
                <div
                    style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
                    <span><strong>Configurations:</strong></span>
                    <div
                        style="display: flex; flex-direction: column; width:500px; max-height: 200px; overflow-y: auto;">
                        @for (config of configurations; track config) {
                        <mat-chip-listbox class="mat-mdc-chip-set-stacked" aria-label="Cutest dog breeds">
                            <mat-chip-option color="primary">
                                Type: {{config.type}} | Action: {{config.action}} | Size: {{config.size}}MB
                                <button matChipRemove (click)="deleteConfiguration(configurations.indexOf(config))">
                                    <mat-icon>cancel</mat-icon>
                                </button>
                            </mat-chip-option>
                        </mat-chip-listbox>
                        }
                    </div>
                </div>
            </mat-card-content>
            <button disabled="" (click)="onboardApplication()" matButton="filled"
                style="display: flex; margin-left: auto; border-radius: 5px; height: 25px;">
                <mat-icon>cloud_upload</mat-icon>
                Confirm Onbording
            </button>
        </mat-card>
    </mat-step>
</mat-stepper>